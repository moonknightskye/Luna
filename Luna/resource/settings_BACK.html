<html>
    <head>
        <META NAME="viewport" CONTENT="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
        <META HTTP-EQUIV="Content-type" CONTENT="text/html; charset=UTF-8" />
        <link href="css/matostyles.css" rel="old stylesheet" type="text/css" />
        <link href="css/lunastyles.css" rel="newer stylesheet" type="text/css" />
        <link href="css/phobosstyles.css" rel="newer stylesheet" type="text/css" />
        <script type="text/javascript" src="js/luna.js" ></script>
        <script type="text/javascript" src="../Apollo11.js" ></script>
        <script type="text/javascript" src="js/phobos.js" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <style>
            /*  PARALLAX EFFECT
                http://codepen.io/saransh/pen/BKJun
            */

            .header {
                margin-bottom: 12pt;
            }

            .scroller-holder {
                width: 100%;
                height: 100%;
                margin: auto;
                background-color: transparent;
                overflow: scroll;
                -webkit-overflow-scrolling: touch;
                position: absolute !important;
                top: 0px;
            }

            .scroller {
                width: 100%;
            }

            .setting-page {
                transition: all 0.4s ease-in-out;
                opacity: 0;
            }

            .setting-page.active {
                z-index: 100;
                position: absolute !important;
                top: 0px;
                left: 0px;
                opacity: 1;
            }

            .section-disclaimer {
                font-size: x-small;
                position: fixed !important;
                left: 0px;
                bottom: 0px;
                margin: 10px;
                color: #616161;
                text-align: justify;
            }

            .section-disclaimer-title {
                text-align: center;
                font-weight: bold !important;
                margin-bottom: 2pt;
            }

            .loading-holder.show {
                opacity: 1;
            }
            .loading-holder {
                transition: all 0.1s ease-in;
                position: fixed !important;
                bottom: 0px;
                right: 0px;
                opacity: 0;
            }

            .content-error {
                transition: all 0.2s ease-in;
                opacity: 1;
            }
            .content-error.content-hide {
                opacity: 0;
            }

            .error {
                color: #e57373 !important;
            }

            #record {
              -webkit-user-select: none;
              -moz-user-select: none;
              -ms-user-select: none;
              user-select: none;
            }


        </style>
        <script>

            var luna = new Luna();
            var audioRecorder;
            var BYTES_PER_CHUNK = ((1024 * 1024)*1);
            var blob;
            var speechSendInterval = -1;
            var voice_id    = 1;

            (function(){
                window.addEventListener("load", function(){
                    loading.classList.add("show");
                    window.setTimeout(function(){
                        cloud_six.classList.add("smove");
                        cloud_four.classList.add("smove");
                    },0);

                    initForm();
                });

                luna.addEventListener( "ready", function(){

                    luna.getAVAudioRecorder().then(function(_audioRecorder){
                        audioRecorder = _audioRecorder;
                        var recuius = document.getElementById("recaius");

                        record.addEventListener("touchstart", function(e){
                            record.innerText = "Recording...";
                            record.classList.add("cancel");
                            record.classList.remove("add");
                            audioRecorder.record().then(function(file){
                                voice_id = 1;
                                blob = new Blob();
                                recuius.click();
                            }, function(error){
                                alert(error)
                            });
                        });
                        record.addEventListener("touchend", function(e){
                            record.innerText = "Record";
                            record.classList.remove("cancel");
                            record.classList.add("add");
                            audioRecorder.stop().then(function(file){
                                audioRecorder.removeEventListener("recording").then(function(){
                                    //audio/x-linear //application/octet-binary
                                    var sBlob = new Blob( [blob], { type: "audio/wav" } ) ;
                                    //var source = window.URL.createObjectURL( );
                                    // var DOM = {
                                    //     tag: "AUDIO",
                                    //     src: source, //"img/speech.wav",
                                    //     controls: "controls"
                                    // };
                                    // var debug = apollo11.getElement(".debug", "SELECT");
                                    // apollo11.appendJSONDOM( DOM, debug );

                                    var context
                                    try {
                                        // Fix up for prefixing
                                        var context = new (window.AudioContext || window.webkitAudioContext);
                                        console.log("Web API created");
                                    } catch(e) {
                                        console.log('Web Audio API is not supported in this browser');
                                    }

                                    let fileReader = new FileReader();
                                    fileReader.onloadend = () => {
                                        var buffer = fileReader.result;
                                        var audioSource = context.createBufferSource();
                                        audioSource.connect( context.destination );

                                        console.log("Blob Loaded", context, buffer, audioSource);
                                        context.decodeAudioData(buffer, function(respose) {
                                            audioSource.buffer = respose;
                                            audioSource.start()
                                            console.log("PLAYED");
                                        },function(err) { 
                                            console.log("ERROR OCCURED");
                                            console.log(err);
                                        });

                                        console.log("RUN")
                                    }
                                    console.log("Reading Blob");
                                    fileReader.readAsArrayBuffer(sBlob);
                                });
                            }, function(error){
                                alert(error)
                            });
                        });

                    });

                    luna.getMainWebview().addEventListener("message", function( message ) {
                        luna.notification().then(function(userNotification){
                            userNotification.show({title:"Failed to load Startup Page", badge:0, body:message, timeInterval:0.5, repeat:false
                               // ,choices:[
                               //  {title:"Penx", value:"Penx", action: function(){ alert("Pen") }},
                               //  {title:"Pineapplex", value:"Pineapplex", action: function(){ alert("Pineapple") }},
                               //  {title:"Applex", value:"Applex", action: function(){ alert("Applex") }}
                               //  ]
                            });
                        });

                        window.setTimeout(function(){
                            apollo11.getElement(".info-message", "SELECT").innerText = message;
                            apollo11.getElement(".content-error", "SELECT").classList.remove("content-hide");

                            var inputelem = apollo11.getElement(".input-text input", "SELECT");
                            inputelem.classList.add("error");
                        },0);
                    });

                    luna.settings().then(function(settings){
                        //luna.debug(settings.getDefaults())
                        window.setTimeout(function(){
                            loading.classList.remove("show");
                        },3500);

                        apollo11.forEveryKey( settings.getDefaults(), function(value, key) {
                            //luna.debug(key + ": " + value)
                            var inputs = apollo11.getElement({src:key},"DATA");
                            apollo11.forEvery(inputs,function(input){
                                if( input.classList.contains("input-checkbox") ) {
                                    input.checked = value;
                                } else if( input.classList.contains("input-text") ) {
                                    var inputelem = apollo11.getElement("input", "SELECT", input);
                                    inputelem.value = value;
                                    if( inputelem.value.length > 0 ) {
                                        window.setTimeout(function(){
                                            inputelem.focus();
                                        },300);
                                    }
                                } else if( input.classList.contains("input-select-btn") ) {
                                    input.dataset.value = value;
                                    apollo11.getElement("SPAN", "SELECT", input).innerText = value;
                                }
                            });

                            apollo11.forEvery(inputs,function(input){
                                if( input.classList.contains("input-checkbox") ) {
                                    input.addEventListener("change",function(e){
                                        settings.set({key:input.dataset.src,value:input.checked});
                                        loading.classList.add("show");
                                        window.setTimeout(function(){
                                            loading.classList.remove("show");
                                        },300);
                                    });
                                } else if( input.classList.contains("input-text") ) {
                                    var inputelem = apollo11.getElement("input", "SELECT", input);
                                    inputelem.addEventListener("blur",function(e){
                                        settings.set({key:input.dataset.src,value:inputelem.value});
                                        loading.classList.add("show");
                                        window.setTimeout(function(){
                                            loading.classList.remove("show");
                                        },300);
                                    });
                                } else if( input.classList.contains("input-select-btn") ) {
                                    input.addEventListener("change",function(e){
                                        settings.set({key:input.dataset.src,value:input.dataset.value});
                                        loading.classList.add("show");
                                        window.setTimeout(function(){
                                            loading.classList.remove("show");
                                        },300);
                                    },false);
                                }
                            });
                        });
                   });
                });
             })();

             //INIT FORM
             var initForm = function(){
                    //var form = document.forms.namedItem("recaius-form");
                    recaius.addEventListener('click', function(ev) {
                        ev.preventDefault();
                        audioRecorder.addEventListener("recording", function(bufferbase64){
                            blob = new Blob([blob, apollo11.base64ToBlob(bufferbase64)]); //audio/x-linear //application/octet-binary
                            if( parseInt(blob.size) >= BYTES_PER_CHUNK ) {
                                //readAudio(blob, voice_id);
                                //console.log(blob,voice_id)
                                voice_id++;
                                //blob = new Blob();
                            }
                        });
                    }, false);
             };
             //INIT FORM

        </script>
    </head>
    <body class="splashscreen settings">
        <section class="phobos matostyle">


            <div class="phobos-page setting-page scroller-holder active">
                <div class="scroller">

                    <div class="section section-setting">
                        <div class="header">LUNA SETTINGS</div> 

                        <div class="section-content">
                            <ul class="flex-box">
                                <li class="flex-one">
                                    <span class="content-label">
                                        Show on
                                    </span>
                                </li>
                                <li class="flex-two">
                                    <span class="phobos-input input-select-btn" data-src="show_settings" data-id="2" data-value="Shake 3 times or greater" data-choices="{
                                      'choices': ['Shake 1 time or greater', 'Shake 3 times or greater', 'Shake 6 times or greater', '1-finger right edge swipe', '2-finger right edge swipe', '3-finger right edge swipe','1-finger left edge swipe', '2-finger left edge swipe', '3-finger left edge swipe']
                                    }">
                                        <span>Shake 3 times or greater</span><i class="arrow right"></i>
                                    </span>
                                </li>
                            </ul>
                            <div class="content-description">
                                <span class="info">ⓘ</span> Activate Luna Settings on gesture
                            </div>
                        </div>

                        <div class="section-content">
                            <ul class="flex-box">
                                <li class="flex-two">
                                    <span class="content-label">
                                        Show Luna Splash Screen
                                    </span>
                                </li>
                                <li class="flex-one">
                                    <input class="phobos-input input-checkbox" type="checkbox" data-src="splash_screen"/>
                                </li>
                            </ul>
                            <div class="content-description">
                                <span class="info">ⓘ</span> Show Luna Splash Screen during startup. Luna Splash Screen prevents displaying a black screen while the Startup Page loads in the background
                            </div>
                        </div>

                        <div class="section-content">
                            <ul class="flex-box">
                                <li class="flex-two">
                                    <span class="content-label">
                                        Startup Page Enabled
                                    </span>
                                </li>
                                <li class="flex-one">
                                    <input class="phobos-input input-checkbox" type="checkbox" data-src="startup_enabled"/>
                                </li>
                            </ul>
                            <div class="content-description">
                                <span class="info">ⓘ</span> Instead of displaying Luna Settings. The app will try to load the Startup Page during app load
                            </div>
                        </div>

                        <div class="section-content">
                            <ul class="flex-box">
                                <li class="flex-two">
                                    <span class="content-label">
                                        Startup Type
                                    </span>
                                </li>
                                <li class="flex-one">
                                    <span class="phobos-input input-select-btn" data-src="startup_type" data-id="1" data-value="URL" data-choices="{
                                      'choices': ['URL', 'Document']
                                    }">
                                        <span>URL</span><i class="arrow right"></i>
                                    </span>
                                </li>
                            </ul>
                            <div class="content-description">
                                <span class="info">ⓘ</span> Specify URL if the Startup Page resides on a server, else choose Document to display iTunes file (transfer HTML files to this app using iTunes on your pc)
                            </div>
                        </div>

                        <div class="section-content">
                            <ul class="flex-box">
                                <li class="flex-one">
                                    <span class="content-label">
                                        Startup Page
                                    </span>
                                </li>
                                <li class="flex-two">
                                    <span class="phobos-input input-text" data-src="startup_page">
                                        <input type="text" />
                                    </span>
                                </li>
                            </ul>
                            <div class="content-description">
                                <span class="info">ⓘ</span> If you chose URL, specify the address including the http prefix. Else, specify the relative path of the HTML file located in iTunes file folder. Providing incorrect parameters will redirect to Luna Settings
                            </div>
                            <div class="content-description content-error content-hide error">
                                <span class="info info-stat">⚠&#xFE0E;</span> <span class="info-message"></span>
                            </div>
                        </div>

                        <div class="section-disclaimer">
                            <div class="section-disclaimer-title">DISCLAIMER</div>
                            Thank you for using this app. This was being updated by Mart Ryan Civil working as a Demo Engineer in Salesforce Tokyo Japan Branch. I distribute this app for free so by using this app the developer is not liable to any damage it will inflict. As for every software there exists bugs, please send email to mcivil@salesforce.com for bug reports. Do understand that I cannot entertain urgent bug fixes for this app is maintained only during on my free time.
                        </div>
                    </div>

                    <div class="debug">
                        DEBUG
                    </div>

                    <div>
                        <div id="recaius" class="custom-button hide">Recaius</div>
                        <div id="record" class="custom-button add">Record</div>
                    </div>
                </div>
            </div>
            <div class="background">
                <div class="moon moon-center" ></div>
                <div id="clound_one" class="cloud-one" ></div>
                <div id="cloud_six" class="cloud-six"></div>
                <div id="cloud_four" class="cloud-four"></div>
            </div>
            <div id="loading" class="loading-holder">
                <div class="loading"></div>
            </div>
        </section>
    </body>
</html>
