<html>
    <head>
        <META NAME="viewport" CONTENT="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
        <META HTTP-EQUIV="Content-type" CONTENT="text/html; charset=UTF-8" />
        <link href="css/matostyles.css" rel="old stylesheet" type="text/css" />
        <link href="css/lunastyles.css" rel="newer stylesheet" type="text/css" />
        <link href="css/phobosstyles.css" rel="newer stylesheet" type="text/css" />
        <script type="text/javascript" src="js/luna.js" ></script>
        <script type="text/javascript" src="../Apollo11.js" ></script>
        <script type="text/javascript" src="js/phobos.js" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <style>
/*        PARALLAX EFFECT
        http://codepen.io/saransh/pen/BKJun
        */

            .header {
                margin-bottom: 12pt;
            }

            .scroller-holder {
                width: 100%;
                height: 100%;
                margin: auto;
                background-color: transparent;
                overflow: scroll;
                -webkit-overflow-scrolling: touch;
                position: absolute !important;
                top: 0px;
            }

            .scroller {
                width: 100%;
            }

            .setting-page {
                transition: all 0.4s ease-in-out;
                opacity: 0;
            }

            .setting-page.active {
                z-index: 100;
                position: absolute !important;
                top: 0px;
                left: 0px;
                opacity: 1;
            }

            .section-disclaimer {
                font-size: x-small;
                position: fixed !important;
                left: 0px;
                bottom: 0px;
                margin: 10px;
                color: #616161;
                text-align: justify;
            }

            .section-disclaimer-title {
                text-align: center;
                font-weight: bold !important;
                margin-bottom: 2pt;
            }

            .loading-holder.show {
                opacity: 1;
            }
            .loading-holder {
                transition: all 0.1s ease-in;
                position: fixed !important;
                bottom: 0px;
                right: 0px;
                opacity: 0;
            }

            .content-error {
                transition: all 0.2s ease-in;
                opacity: 1;
            }
            .content-error.content-hide {
                opacity: 0;
            }

            .error {
                color: #e57373 !important;
            }

            #record {
              -webkit-user-select: none;
              -moz-user-select: none;
              -ms-user-select: none;
              user-select: none;
            }


        </style>
        <script>

            var luna = new Luna();

            var wavFile;
            (function(){
                window.addEventListener("load", function(){
                    loading.classList.add("show");
                    window.setTimeout(function(){
                        cloud_six.classList.add("smove");
                        cloud_four.classList.add("smove");
                    },0);

                    initForm();
                });

                luna.addEventListener( "ready", function(){

                    luna.getAVAudioRecorder().then(function(audioRecorder){
                        var recuius = document.getElementById("recaius");

                        record.addEventListener("touchstart", function(e){
                            record.innerText = "Recording...";
                            record.classList.add("cancel");
                            record.classList.remove("add");
                            audioRecorder.record();
                        });
                        record.addEventListener("touchend", function(e){
                            record.innerText = "Record";
                            record.classList.remove("cancel");
                            record.classList.add("add");
                            audioRecorder.stop().then(function(file){
                                audioRecorder.convertAudioToWav({file:file}).then(function(encoded){
                                    wavFile = encoded;
                                    recuius.click();
                                    recuius.focus();
                                    record.blur();
                                }, function(error){
                                    alert(error)
                                });
                            }, function(error){
                                alert(error)
                            });
                        });

                    });

                    
                    

                    // luna.httpPost({
                    //     method       : "POST",
                    //     url          : "https://api.recaius.jp/auth/v2/tokens",
                    //     headers      : { 
                    //         "Content-Type"  : "application/json",
                    //         "Accept"        : "application/json"
                    //     },
                    //     data : { 
                    //         speech_recog_jaJP : { 
                    //             service_id: 'sfdcjpdemo01_MA9N7kF3h9', 
                    //             password: 'sfdc1234' 
                    //         },
                    //         speech_recog_enUS: { 
                    //             service_id: 'sfdcjpdemo01_MA9N7kF3h9_enUS',
                    //             password: 'sfdc1234' 
                    //         },
                    //         speech_recog_zhCN: { 
                    //             service_id: 'sfdcjpdemo01_MA9N7kF3h9_zhCN',
                    //             password: 'sfdc1234' 
                    //         }, 
                    //         expiry_sec: 3600 
                    //     }
                    // }).then(function(result){
                    //     window.setTimeout(function(){
                    //         luna.httpPost({
                    //             method      : "POST",
                    //             url         : "https://api.recaius.jp/asr/v2/voices",
                    //             headers      : { 
                    //                 "X-Token"       : result.token,
                    //                 "Content-Type"  : "application/json",
                    //                 "Accept"        : "application/json"
                    //             },
                    //             data : { 
                    //                 energy_threshold    : 300,
                    //                 model_id            : 1,
                    //                 audio_type          : "audio/x-linear",
                    //                 push_to_talk        : false,
                    //                 result_type         : "nbest",
                    //                 result_count        : 1
                    //             }
                    //         }).then(function(result){
                    //             alert(JSON.stringify(result))
                    //         });


                    //     },0);
                    // });

                    luna.getMainWebview().addEventListener("message", function( message ) {
                        luna.notification().then(function(userNotification){
                            userNotification.show({title:"Failed to load Startup Page", badge:0, body:message, timeInterval:0.5, repeat:false
                               // ,choices:[
                               //  {title:"Penx", value:"Penx", action: function(){ alert("Pen") }},
                               //  {title:"Pineapplex", value:"Pineapplex", action: function(){ alert("Pineapple") }},
                               //  {title:"Applex", value:"Applex", action: function(){ alert("Applex") }}
                               //  ]
                            });
                        });

                        // window.setTimeout(function(){
                        //     luna.notification().then(function(userNotification){
                        //         userNotification.show({title:"TEST", badge:0, body:message, timeInterval:0.5, repeat:false
                        //            ,choices:[
                        //             {title:"XXXX", value:"XXXX", action: function(){ alert("Pen") }},
                        //             {title:"YYYY", value:"YYYY", action: function(){ alert("Pineapple") }},
                        //             {title:"ZZZZ", value:"ZZZZ", action: function(){ alert("Applex") }}
                        //             ]
                        //         });
                        //     });
                        // },5000);

                        window.setTimeout(function(){
                            apollo11.getElement(".info-message", "SELECT").innerText = message;
                            apollo11.getElement(".content-error", "SELECT").classList.remove("content-hide");

                            var inputelem = apollo11.getElement(".input-text input", "SELECT");
                            inputelem.classList.add("error");
                        },0);
                    });

                    luna.settings().then(function(settings){
                        //luna.debug(settings.getDefaults())
                        window.setTimeout(function(){
                            loading.classList.remove("show");
                        },3500);

                        apollo11.forEveryKey( settings.getDefaults(), function(value, key) {
                            //luna.debug(key + ": " + value)
                            var inputs = apollo11.getElement({src:key},"DATA");
                            apollo11.forEvery(inputs,function(input){
                                if( input.classList.contains("input-checkbox") ) {
                                    input.checked = value;
                                } else if( input.classList.contains("input-text") ) {
                                    var inputelem = apollo11.getElement("input", "SELECT", input);
                                    inputelem.value = value;
                                    if( inputelem.value.length > 0 ) {
                                        window.setTimeout(function(){
                                            inputelem.focus();
                                        },300);
                                    }
                                } else if( input.classList.contains("input-select-btn") ) {
                                    input.dataset.value = value;
                                    apollo11.getElement("SPAN", "SELECT", input).innerText = value;
                                }
                            });

                            apollo11.forEvery(inputs,function(input){
                                if( input.classList.contains("input-checkbox") ) {
                                    input.addEventListener("change",function(e){
                                        settings.set({key:input.dataset.src,value:input.checked});
                                        loading.classList.add("show");
                                        window.setTimeout(function(){
                                            loading.classList.remove("show");
                                        },300);
                                    });
                                } else if( input.classList.contains("input-text") ) {
                                    var inputelem = apollo11.getElement("input", "SELECT", input);
                                    inputelem.addEventListener("blur",function(e){
                                        settings.set({key:input.dataset.src,value:inputelem.value});
                                        loading.classList.add("show");
                                        window.setTimeout(function(){
                                            loading.classList.remove("show");
                                        },300);
                                    });
                                } else if( input.classList.contains("input-select-btn") ) {
                                    input.addEventListener("change",function(e){
                                        settings.set({key:input.dataset.src,value:input.dataset.value});
                                        loading.classList.add("show");
                                        window.setTimeout(function(){
                                            loading.classList.remove("show");
                                        },300);
                                    },false);
                                }
                            });
                        });
                   });
                });
             })();

             //INIT FORM
             var initForm = function(){
                    //var form = document.forms.namedItem("recaius-form");
                    recaius.addEventListener('click', function(ev) {
                        ev.preventDefault();


                        $.ajax({
                          type: "POST",
                          url: "https://api.recaius.jp/auth/v2/tokens",
                          headers: {
                            "Content-Type"  : "application/json",
                            "Accept"        : "application/json"
                          },
                          dataType: "json",
                          data: JSON.stringify({ 
                                speech_recog_jaJP : { 
                                    service_id: 'sfdcjpdemo01_MA9N7kF3h9', 
                                    password: 'sfdc1234' 
                                },
                                speech_recog_enUS: { 
                                    service_id: 'sfdcjpdemo01_MA9N7kF3h9_enUS',
                                    password: 'sfdc1234' 
                                },
                                speech_recog_zhCN: { 
                                    service_id: 'sfdcjpdemo01_MA9N7kF3h9_zhCN',
                                    password: 'sfdc1234' 
                                }, 
                                expiry_sec: 3600 
                          }),
                          success: function( result ) {

                            var token = result.token;
                            var base_model_id = 1;

                            console.log("[INFO] ACQUIRED TOKEN ID: ", token);

                            $.ajax({
                                type: "PUT",
                                url: "https://api.recaius.jp/asr/v2/models/" + base_model_id + "/configuration",
                                headers: {
                                    "Content-Type"  : "application/json",
                                    "X-Token"       : token
                                },
                                dataType: "json",
                                data: JSON.stringify({ 
                                    arabic_numerals        : 0
                                }),
                                success: function( result ) {
                                    console.log("[INFO] CONFIGURATION: ", result);

                                    $.ajax({
                                      type: "POST",
                                      url: "https://api.recaius.jp/asr/v2/voices",
                                      headers: {
                                        "X-Token"       : token,
                                        "Content-Type"  : "application/json",
                                        "Accept"        : "application/json"
                                      },
                                      dataType: "json",
                                      data: JSON.stringify({ 
                                        energy_threshold    : 300, //300
                                        model_id            : 1,
                                        audio_type          : "audio/x-linear",
                                        push_to_talk        : false,
                                        result_type         : "one_best",
                                        result_count        : 1, //1
                                        data_log            : 1,
                                        comment             : "Hello World!"
                                      }),
                                      success: function( result ) {
                                        //alert(JSON.stringify(result))

                                        var uuid        = result.uuid;
                                        var voice_id    = 1;
                                        console.log("[INFO] ACQUIRED UUID: ", uuid);

                                        // luna.getFile({
                                        //     filename:   "recording.wav",
                                        //     path_type:  "document",
                                        // }).then(function( file ){
                                        //     file.getBase64().then(function(base64){
                                        //         readAudio(apollo11.base64ToBlob(base64));
                                        //     });
                                        // });
                                        if(!wavFile){
                                            return;
                                        }

                                        wavFile.getBase64().then(function(base64){
                                            readAudio(apollo11.base64ToBlob(base64));
                                        });

                                        var readAudio = function(blob){
                                                var fd = new FormData();
                                                fd.append("voice_id", voice_id);
                                                fd.append("voice", blob);
                                                var hasResult = false;
                                                
                                                $.ajax({
                                                    url: "https://api.recaius.jp/asr/v2/voices/" + uuid,
                                                    type: "PUT",
                                                    headers: {
                                                        "X-Token"       : token
                                                    },
                                                    data: fd,
                                                    processData: false,  // jQuery がデータを処理しないよう指定
                                                    contentType: false,  // jQuery が contentType を設定しないよう指定
                                                    success: function(result){  

                                                        console.log("[INFO] VOICE DATA SENT");
                                                        console.log("[INFO] RESULT: ", result);

                                                        var flush = function(){
                                                            $.ajax({
                                                                type: "PUT",
                                                                url: "https://api.recaius.jp/asr/v2/voices/" + uuid + "/flush",
                                                                headers: {
                                                                    "Content-Type"  : "application/json",
                                                                    "X-Token"       : token
                                                                },
                                                                dataType: "json",
                                                                data: JSON.stringify({ 
                                                                    voice_id        : voice_id
                                                                }),
                                                                success: function( result ) {
                                                                    console.log("[INFO] FLUSHED");
                                                                    $.ajax({
                                                                        type: "DELETE",
                                                                        url: "https://api.recaius.jp/auth/v2/tokens",
                                                                        headers: {
                                                                            "X-Token"       : token
                                                                        },
                                                                        success: function( result ) {
                                                                            console.log("[INFO] TOKEN DELETED");
                                                                            if(!hasResult) {
                                                                                alert("[INFO] NO RESULT");
                                                                            }
                                                                        },
                                                                        error: function(XMLHttpRequest, textStatus, errorThrown) { 
                                                                            console.log(XMLHttpRequest);
                                                                            alert(XMLHttpRequest.responseJSON.message);
                                                                        }
                                                                    });
                                                                }
                                                            });
                                                        };

                                                        var interval = window.setInterval(function(){
                                                            $.ajax({
                                                                type: "GET",
                                                                url: "https://api.recaius.jp/asr/v2/voices/" + uuid + "/results",
                                                                headers: {
                                                                    "X-Token"       : token
                                                                },
                                                                success: function( result ) {
                                                                    if(!result) {
                                                                        window.clearInterval(interval);
                                                                        flush();
                                                                    } else {
                                                                        // console.log("[INFO] RESULT: ", result);
                                                                        for (s of result) {
                                                                            if(s[0] === "RESULT") {
                                                                                console.log("[INFO] RESULT: ", s[1]);
                                                                                alert(s[1]);
                                                                                hasResult = true;
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            });
                                                        },300);
                                                    },
                                                    error: function(XMLHttpRequest, textStatus, errorThrown) { 
                                                        console.log(XMLHttpRequest);
                                                        alert(XMLHttpRequest.responseJSON.message);
                                                    }
                                                });

                                        };
                                      },
                                        error: function(XMLHttpRequest, textStatus, errorThrown) { 
                                            console.log(XMLHttpRequest);
                                            alert(XMLHttpRequest.responseJSON.message);
                                        }
                                    });

                                },
                                error: function(XMLHttpRequest, textStatus, errorThrown) { 
                                    console.log(XMLHttpRequest);
                                    alert(XMLHttpRequest.responseJSON.message);
                                }
                            });
                        }
                    });
                    }, false);
             

             };
             //INIT FORM

        </script>
    </head>
    <body class="splashscreen settings">
        <section class="phobos matostyle">


            <div class="phobos-page setting-page scroller-holder active">
                <div class="scroller">

                    <div class="section section-setting">
                        <div class="header">LUNA SETTINGS</div> 

                        <div class="section-content">
                            <ul class="flex-box">
                                <li class="flex-one">
                                    <span class="content-label">
                                        Show on
                                    </span>
                                </li>
                                <li class="flex-two">
                                    <span class="phobos-input input-select-btn" data-src="show_settings" data-id="2" data-value="Shake 3 times or greater" data-choices="{
                                      'choices': ['Shake 1 time or greater', 'Shake 3 times or greater', 'Shake 6 times or greater', '1-finger right edge swipe', '2-finger right edge swipe', '3-finger right edge swipe','1-finger left edge swipe', '2-finger left edge swipe', '3-finger left edge swipe']
                                    }">
                                        <span>Shake 3 times or greater</span><i class="arrow right"></i>
                                    </span>
                                </li>
                            </ul>
                            <div class="content-description">
                                <span class="info">ⓘ</span> Activate Luna Settings on gesture
                            </div>
                        </div>

                        <div class="section-content">
                            <ul class="flex-box">
                                <li class="flex-two">
                                    <span class="content-label">
                                        Show Luna Splash Screen
                                    </span>
                                </li>
                                <li class="flex-one">
                                    <input class="phobos-input input-checkbox" type="checkbox" data-src="splash_screen"/>
                                </li>
                            </ul>
                            <div class="content-description">
                                <span class="info">ⓘ</span> Show Luna Splash Screen during startup. Luna Splash Screen prevents displaying a black screen while the Startup Page loads in the background
                            </div>
                        </div>

                        <div class="section-content">
                            <ul class="flex-box">
                                <li class="flex-two">
                                    <span class="content-label">
                                        Startup Page Enabled
                                    </span>
                                </li>
                                <li class="flex-one">
                                    <input class="phobos-input input-checkbox" type="checkbox" data-src="startup_enabled"/>
                                </li>
                            </ul>
                            <div class="content-description">
                                <span class="info">ⓘ</span> Instead of displaying Luna Settings. The app will try to load the Startup Page during app load
                            </div>
                        </div>

                        <div class="section-content">
                            <ul class="flex-box">
                                <li class="flex-two">
                                    <span class="content-label">
                                        Startup Type
                                    </span>
                                </li>
                                <li class="flex-one">
                                    <span class="phobos-input input-select-btn" data-src="startup_type" data-id="1" data-value="URL" data-choices="{
                                      'choices': ['URL', 'Document']
                                    }">
                                        <span>URL</span><i class="arrow right"></i>
                                    </span>
                                </li>
                            </ul>
                            <div class="content-description">
                                <span class="info">ⓘ</span> Specify URL if the Startup Page resides on a server, else choose Document to display iTunes file (transfer HTML files to this app using iTunes on your pc)
                            </div>
                        </div>

                        <div class="section-content">
                            <ul class="flex-box">
                                <li class="flex-one">
                                    <span class="content-label">
                                        Startup Page
                                    </span>
                                </li>
                                <li class="flex-two">
                                    <span class="phobos-input input-text" data-src="startup_page">
                                        <input type="text" />
                                    </span>
                                </li>
                            </ul>
                            <div class="content-description">
                                <span class="info">ⓘ</span> If you chose URL, specify the address including the http prefix. Else, specify the relative path of the HTML file located in iTunes file folder. Providing incorrect parameters will redirect to Luna Settings
                            </div>
                            <div class="content-description content-error content-hide error">
                                <span class="info info-stat">⚠&#xFE0E;</span> <span class="info-message"></span>
                            </div>
                        </div>

                        <div class="section-disclaimer">
                            <div class="section-disclaimer-title">DISCLAIMER</div>
                            Thank you for using this app. This was being updated by Mart Ryan Civil working as a Demo Engineer in Salesforce Tokyo Japan Branch. I distribute this app for free so by using this app the developer is not liable to any damage it will inflict. As for every software there exists bugs, please send email to mcivil@salesforce.com for bug reports. Do understand that I cannot entertain urgent bug fixes for this app is maintained only during on my free time.
                        </div>
                    </div>

                    <div class="debug"></div>

                    <div>
                            <div id="recaius" class="custom-button hide">Recaius</div>
                            <div id="record" class="custom-button add">Record</div>
                        </div>
                </div>
            </div>
            <div class="background">
                <div class="moon moon-center" ></div>
                <div id="clound_one" class="cloud-one" ></div>
                <div id="cloud_six" class="cloud-six"></div>
                <div id="cloud_four" class="cloud-four"></div>
            </div>
            <div id="loading" class="loading-holder">
                <div class="loading"></div>
            </div>
        </section>
    </body>
</html>
